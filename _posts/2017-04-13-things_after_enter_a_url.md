---
layout: post
title: "URL输入到页面加载完成的过程"
date: 2017-04-13
description: ""
tag: Others
---

### 整体过程
-	输入地址
-	浏览器先查看浏览器缓存-系统缓存-路由器缓存，如果缓存中有，直接在屏幕中显示页面内容(此时没有向服务器发请求)；若没有，则进入下一步操作
-	通过 DNS 解析获取网址的IP地址
-	向真实 IP 地址服务器通过 TCP 连接发送 HTTP 请求，HTTP 三次握手
-	浏览器接受 HTTP 响应
-	检查 HTTP header 里的状态码，并作出不同的处理
-	浏览器进行解码响应，同时设置缓存
-	浏览器解析渲染页面
-	关闭 TCP 连接(四次挥手)

### DNS 解析
DNS解析就是找到一个网址对应的 IP 地址。DNS解析是一个递归查询的过程。

以查找 www.google.com 的 IP 地址过程为例：
![DNS解析](/images/posts/url/DNS.png)
-	首先在本地域名服务器中查询IP地址；
-	如果没有找到的情况下，本地域名服务器会向根域名服务器发送一个请求；
-	如果根域名服务器也不存在该域名时，本地域名会向 com 顶级域名服务器发送一个请求，依次类推下去；
-	直到最后本地域名服务器得到 google 的 IP 地址并把它缓存到本地，供下次查询使用。

从上述过程中，可以看出网址的解析是一个从右向左的过程: com -> google.com -> www.google.com。

但是你是否发现少了点什么，根域名服务器的解析过程呢？事实上，真正的网址是 www.google.com. ，这个 . 对应的就是根域名服务器，默认情况下所有的网址的最后一位都是 . ，既然是默认情况下，为了方便用户，通常都会省略，浏览器在请求DNS的时候会自动加上。

**所有网址真正的解析过程为: . -> .com -> google.com. -> www.google.com.**
### TCP 连接
找到服务器的 IP 地址后，会建立一次连接，由 TCP 协议来完成，主要通过三次握手进行连接。

#### 三次握手过程
-	第一次握手：建立连接时，客户端发送 SYN(SYN = j) 包到服务器，并进入 SYN_SENT 状态，等待服务器确认；
-	第二次握手：服务器收到 SYN 包，必须确认客户的 SYN(ACK = j + 1)，同时自己也发送一个 SYN(SYN = k) 包，此时服务器进入 SYN_SENT 状态；
-	第三次握手：客户端收到服务器的 SYN+ACK 包，向服务器发送确认包 ACK(ACK = k + 1)，此包发送完毕，客户端和服务器端进入 ESTABLISHED(TCP 连接成功) 状态，完成三次握手

三次握手完成后，客户端与服务器端就可以开始传送数据了。
![三次握手](/images/posts/url/TCP.png)

#### TCP 标志位
-	SYN(synchronous) 建立联机
-	ACK(acknowledgement) 确认
-	PSH(push) 传送
-	FIN(finish) 结束
-	RST(reset) 重置
-	URG(urgent) 紧急

确认号：其数值等于发送方的发送序列号 + 1 (即接收方期望接受的下一个序列号)
### 浏览器接受响应
服务器在收到浏览器发送的 HTTP 请求后，会将收到的 HTTP 报文封装成 HTTP 的 Request 对象，并通过不同的 Web 服务器进行处理，处理完的结果以 HTTP 的 Request 对象返回，主要包括状态码，响应头，响应报文三个部分。
#### 状态码
-	1XX : 指示信息
-	2XX ：成功
-	3XX ：重定向
-	4XX ：客户端错误
-	5XX ：服务器端错误

#### 响应头
主要由 Cashe-Control 、Connection 、Data 、Pragma 等组成
#### 响应体
服务器返回给浏览器的信息，主要由 HTML ，CSS ，JS ，图片文件组成
### 浏览器渲染页面过程
浏览器渲染页面过程比较多，记录在另一篇文章中 ----&gt; [浏览器页面渲染过程](http://blog.lupath.com/2017/04/browser_render_web_page/)

### 关闭 TCP 连接(四次挥手)
由于 TCP 是全双工的，每个方向都必须单独关闭。原则是一方完成数据发送任务后发送一个 FIN 来终止这个方向的连接。收到一个 FIN 只意味着这一个方向上没有数据流动，一个 TCP 连接在收到一个 FIN 后仍能发送数据。首先进行关闭的一方执行主动关闭，而另一方执行被动关闭。

客户端和服务器端均可主动发起挥手动作。

#### 四次挥手过程
-	第一次挥手：浏览器发送 FIN 报文段断开连接，此时，浏览器进入 FIN_WAIT_1 状态，表示浏览器没有数据要发送给服务器了
-	第二次挥手：服务器收到浏览器发送的 FIN 报文段，，想浏览器回一个 ACK 报文段，浏览器进入 FIN_WAIT_2 状态，服务器告诉浏览器，我“同意”你的关闭请求。*--此时服务器依旧可以浏览器发送数据*
-	第三次挥手：服务器想主机发送 FIN 报文段，请求关闭连接，此时，服务器进入 LAST_ACK 状态
-	第四次挥手：浏览器收到服务器发送的 FIN 报文段，想服务器发送 ACK 报文段，然后浏览器进入 TIME_WAIT 状态，服务器收到浏览器的 ACK 报文段后，关闭连接；此时浏览器等待 2MSL 后依旧没有收到回复，则证明服务器端已正常关闭，浏览器端随即关闭连接。

四次挥手完成后，客户端与服务器端的连接全部关闭。
![四次挥手](/images/posts/url/TCP_1.png)

>参考文档：
- [从输入url到页面加载完成发生了什么？——前端角度](http://www.cnblogs.com/daijinxue/p/6640153.html) 作者：踮起脚尖眺望6
- [前端经典面试题: 从输入URL到页面加载发生了什么？](https://segmentfault.com/a/1190000006879700) 作者：simon_woo
- [通俗大白话来理解TCP协议的三次握手和四次分手](https://segmentfault.com/a/1190000009183220) 作者：微醺岁月

